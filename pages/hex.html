<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>hexscanner</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="../css/terminal.css">
        <link rel="stylesheet" href="../css/editor.css">
        <script src="../js/vendor/jquery.js"></script>
        <script src="../js/vendor/honeycomb.min.js"></script>
        <script type="text/javascript" src="../js/vendor/jscolor/jscolor.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.0.16/svg.min.js"></script>
        <script src="https://kit.fontawesome.com/db74c35348.js" crossorigin="anonymous"></script>
        <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-database.js"></script>
    </head>
    <body style="text-transform:unset;">
        <div class="menu-bar-outer" id="menu-bar-outer">
            <div class="menu-bar" id="menu-bar">
                <div class="item palette-button" title="Change colour"><input id="color-picker" class="color" value="14fdce" spellcheck="false"></div>
                <div class="item symbol-button" title="Change symbol"><input id="symbol-picker" type="text" maxlength="1" onkeypress=changeSymbol(event) value="#"/></div>
                <div class="item clear-button" title="Clear the canvas"><i class="fas fa-trash"></i></div>
            </div>
        </div>
        <div class="noselect">
            <div id="glow" class="glow noclick"></div>
            <div id="noisy" class="noisy noclick"></div>
            <div id="scanline" class="scanlines noclick"></div>
        </div>
    </body>
    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyDXisJDCGBWCMk58n0CC3upa0xAyXeiknM",
            authDomain: "terminal-b1033.firebaseapp.com",
            databaseURL: "https://terminal-b1033.firebaseio.com",
            projectId: "terminal-b1033",
            storageBucket: "terminal-b1033.appspot.com",
            messagingSenderId: "705305494904",
            appId: "1:705305494904:web:1ac9f9db1472cb82a2748d",
            measurementId: "G-5Q9MSLZETV"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        var charKey = urlParams.get('key');

        const fontSize = 18;
        var hexSize = 20;
        const draw = SVG().addTo('body').size('100%', '100%')
        var Hex = Honeycomb.extendHex({ size: hexSize })
        var Grid = Honeycomb.defineGrid(Hex)
        var grid = setUp();

        var database = [];
        var current_color = '#14fdce';
        var current_text = "#";

        function render(){
            draw.clear();
            for(i=0;i<grid.length;i++){
                grid[i].text = database[i].text;
                grid[i].color = database[i].color;
                grid[i].selected = database[i].selected;
                grid[i].render(draw);
            }
            for(i=0;i<grid.length;i++){
                if(database[i].selected){
                    grid[i].renderHighlighted(draw);
                }
            }
        }

        function clear(){
            for(i=0;i<database.length;i++){
                database[i].text = '';
                database[i].color = '0000';
                database[i].selected = false;
            }
            storeDatabase();
            render();
        }

        function setUp(){
            Hex = Honeycomb.extendHex({
                size: Math.min($(window).width()/35, $(window).height()/35),
                orientation: 'flat',
                origin: {x:-1 * ($(window).width()/2 - hexSize), y: -1 * ($(window).height()/2 - hexSize)},
                text: '',
                color: '',

                render(draw) {
                    const position = this.toPoint()
                    const centerPosition = this.center().add(position)
                    this.draw = draw
                    // draw the hex
                    this.draw
                        .polygon(this.corners().map(({ x, y }) => `${x},${y}`))
                        .fill('none')
                        .stroke({ width: 2, color: '#26754e'})
                        .translate(position.x, position.y)
                },
                renderHighlighted(draw) {
                    const position = this.toPoint()
                    const centerPosition = this.center().add(position)
                    this.draw = draw
                    // draw the hex
                    this.draw
                        .polygon(this.corners().map(({ x, y }) => `${x},${y}`))
                        .fill('none')
                        .stroke({ width: 3, color: this.color})
                        .translate(position.x, position.y)
                    this.draw
                        .text(this.text)
                        .font({
                            size: fontSize,
                            anchor: 'middle',
                            leading: 1.4,
                            fill: this.color
                        })
                        .translate(centerPosition.x, centerPosition.y - fontSize)
                },
                highlight() {
                    const position = this.toPoint()
                    const centerPosition = this.center().add(position)
                    poly = this.draw.polygon(this.corners().map(({ x, y }) => `${x},${y}`))
                    .stroke({ width: 3, color: '#26754e' })
                    .fill({ opacity: 1, color: '#26754e' })
                    .translate(position.x, position.y)
                    .animate(1000).fill({ opacity: 0, color: this.color }).stroke({ width: 3, color: this.color });
                    // draw content
                    this.draw
                        .text(this.text)
                        .font({
                            size: fontSize,
                            anchor: 'middle',
                            leading: 1.4,
                            fill: this.color
                        })
                        .translate(centerPosition.x, centerPosition.y - fontSize)
                }
            })

            Grid = Honeycomb.defineGrid(Hex)
            var grid = Grid.hexagon({
                radius: 8,
                center: [0, 0],
                onCreate(hex){
                    var hex_text = `#`;
                    var hex_color = '#14fdce'
                    hex.text = hex_text;
                    hex.color = '#14fdce';
                }
            })
            return grid;
        }

        document.addEventListener('click', ({ offsetX, offsetY }) => {
            const hexCoordinates = Grid.pointToHex([offsetX, offsetY])
            const hex = grid.get(hexCoordinates)
            if (hex) {
                database[grid.indexOf(hex)].text = current_text;
                database[grid.indexOf(hex)].color = current_color;
                database[grid.indexOf(hex)].selected = true;
                storeCellDatabase(grid.indexOf(hex))
                hex.highlight();
                render();
            }
        });

        document.addEventListener('contextmenu', function(e){
            e.preventDefault();
            const hexCoordinates = Grid.pointToHex([e.offsetX, e.offsetY])
            const hex = grid.get(hexCoordinates)
            if (hex) {
                current_color = database[grid.indexOf(hex)].color;
                current_text = database[grid.indexOf(hex)].text;
                // database[grid.indexOf(hex)].selected = false;
                // storeCellDatabase(grid.indexOf(hex));
                // render();
            }
        });

        var rtime;
        var timeout = false;
        var delta = 100;

        $(window).resize(function() {
            rtime = new Date();
            if (timeout === false) {
                timeout = true;
                setTimeout(resizeend, delta);
            }
        });

        function resizeend() {
            if (new Date() - rtime < delta) {
                setTimeout(resizeend, delta);
            } else {
                timeout = false;
                draw.clear();
                grid = setUp();
                render();
            }
        }

        $('#color-picker').change($.proxy(function() {
            current_color = `#${$('#color-picker').val()}`
        }, this));
        $('.menu-bar .clear-button').click($.proxy(function() {
            clear();
        }, this));

        function changeSymbol(event){
            current_text = String.fromCharCode(event.which);
            $('#symbol-picker').val(String.fromCharCode(event.which));
        }

        function storeDatabase() {
            var updates = {};
            updates['/hexes/' + charKey] = database;
            return firebase.database().ref().update(updates);
        }

        function storeCellDatabase(i) {
            var updates = {};
            updates['/hexes/' + charKey +'/'+ i] = database[i];
            return firebase.database().ref().update(updates);
        }

        function loadDatabase(){
            firebase.database().ref('/hexes/' + charKey).once('value').then(function(snapshot) {
                val = snapshot.val();
                database = val;
                render();
            });
        }


        $(document).ready(function () {
            if (charKey === null) {
                charKey = firebase.database().ref().child('characters').push().key;
                urlParams.set('key', charKey);
                window.history.replaceState({}, '', `${location.pathname}?${urlParams}`);
                storeDatabase();
                render();
            } else {
                loadDatabase();
            }
        });

    </script>
</html>